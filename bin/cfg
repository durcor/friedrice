#!/bin/sh

. $HOME/.cache/wal/colors.sh

[ ! -f ~/.config/cfg/al ] && mkdir -p ~/.config/cfg && touch ~/.config/cfg/al

refreshcfg() {
    wpg -s "$(wpg -c)"

    command -v openrgb >/dev/null &&
        sudo openrgb \
        -d 0 `# Left RAM Stick` \
            -c "$(echo $color14 | sed 's/#//')" -m Static \
        -d 1 `# Right RAM Stick` \
            -c "$(echo $color9 | sed 's/#//')" -m Static \
        -d 2 `# X570 Taichi` \
            `#-c ${color9:1} -m Neon \ ` \
            -m Random &

    lsusb | grep -q NZXT && 
        if liquidctl; then
            sudo liquidctl set led1 color starry-night "$(echo "$color14" | sed 's/#//')" &
            sudo liquidctl set led2 color starry-night "$(echo "$color11" | sed 's/#//')" &
        else
            openrgb -d 3 \
                -z 0 -c "$(echo "$color13" | sed 's/#//')" \
                -z 1 -c "$(echo "$color19" | sed 's/#//')" \
                -z 2 -c "$(echo "$color11" | sed 's/#//')" \
                -z 3 -c "$(echo "$color10" | sed 's/#//')" &
        fi

    lsusb | grep -q AMD &&
        wraith-master -m swirl -c "$color14" ring &&
        wraith-master -m static -c "$color11" logo &&
        wraith-master --mirage on fan &&
        wraith-master -c "$color9" fan &

    lsusb | grep -q Microdia && rgb_keyboard -c 000000 &
    lsusb | grep -q Razer && razerricer &
    [ "$(pgrep qutebrowser)" ] && qutebrowser :config-source &

    if [ "$WAYLAND_DISPLAY" ]; then
        sway restart &
    else
        i3 restart
        sleep 0.1
        i3 mode WINDOW
    fi

    cd ~/prg/st || exit
    sudo make clean install || exit
    cd ~/prg/dmenu || exit
    sudo make clean install || exit
    cd ~/prg/slock || exit
    sudo make clean install || exit
    wal_steam -g &
    pywalfox update &
    oomox-cli ~/.cache/wal/colors-oomox &
    # oomoxify-cli -s /opt/spotify/Apps ~/.cache/wal/colors-oomox
    pywal-discord
    sleep 1
    pywal-discord

    if pgrep spotify; then
        spicetify apply
        sleep 1
        playerctl -p spotify play
    else
        spicetify apply
        sleep 1
        killall -9 spotify
    fi
}


addcfg() {
    cfgalias=$3
    newcfg=$(readlink -f "$2")
    echo "$cfgalias $newcfg" >> ~/.config/cfg/al
}

editcfg() {
    if [ -z "$2"  ]; then
        cfgfileloc="$(sed "s/~/\/home\/$USER/" ~/.config/cfg/al | awk '{print $2}' | fzf)"
    else
        cfgfileloc="$(sed "s/~/\/home\/$USER/" ~/.config/cfg/al | grep "^$2 " | awk '{print $2}')"
    fi

    cfgfilepostrun="$(grep "$(echo "$cfgfileloc" | sed "s/\/home\/$USER/~/")" ~/.config/cfg/al | awk '{$1="";$2="";print}' | xargs)"

    if [ -O "$cfgfileloc" ]; then
        $EDITOR "$cfgfileloc"
    else
        sudoedit "$cfgfileloc"
    # Only advance onto the post run command if the edit of the
    # file succeeds
    fi &&

    [ -n "$cfgfilepostrun" ] && $SHELL -c "$cfgfilepostrun"
}

listcfg() {
    awk '{print $1}' ~/.config/cfg/al
}

updatecfg() {
    cd "$HOME" || exit
    for f in ~/bin/*; do
        git add -f "$f" || exit
    done
    for f in ~/.config/wpg/templates/*.base; do
        git add -f "$f" || exit
    done
    pacman -Qeq > ~/.config/pkgs
    git commit -a
    git push
}

case $1 in
    r|rf|re|refresh)refreshcfg;;
    a|add)addcfg "$@";;
    e|ed|edit)editcfg "$@";;
    l|ls|list)listcfg;;
    u|up|update)updatecfg;;
esac
